<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Images - Sanny Store</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 0; }
        .info { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #c8e6c9; }
        .error { background: #ffcdd2; }
        .image-test {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .image-test img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin-right: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .image-test img.loaded {
            border-color: #4caf50;
        }
        .image-test img.error {
            border-color: #f44336;
        }
        .image-info {
            flex: 1;
        }
        .url {
            font-family: monospace;
            font-size: 12px;
            background: #eee;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
            margin: 5px 0;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.ok { background: #4caf50; color: white; }
        .status.fail { background: #f44336; color: white; }
    </style>
</head>
<body>
    <h1>üñºÔ∏è Test d'Affichage des Images - Sanny Store</h1>
    
    <div class="test-section info">
        <h2>üìä Informations Environnement</h2>
        <p><strong>Hostname:</strong> <span id="hostname"></span></p>
        <p><strong>URL Actuelle:</strong> <span id="current-url"></span></p>
        <p><strong>Backend D√©tect√©:</strong> <span id="backend-url"></span></p>
        <p><strong>Date Test:</strong> <span id="test-date"></span></p>
    </div>

    <div class="test-section">
        <h2>üîç Test 1: Images depuis Base de Donn√©es</h2>
        <p>R√©cup√©ration des produits depuis l'API et test d'affichage</p>
        <div id="products-container"></div>
    </div>

    <div class="test-section">
        <h2>üß™ Test 2: URLs Hardcod√©es (Test Normalisation)</h2>
        <div id="hardcoded-tests"></div>
    </div>

    <div class="test-section">
        <h2>‚òÅÔ∏è Test 3: Images Cloudinary</h2>
        <div id="cloudinary-tests"></div>
    </div>

    <div class="test-section" id="results">
        <h2>üìà R√©sultats des Tests</h2>
        <div id="results-summary"></div>
    </div>

    <script>
        // D√©tection du backend (m√™me logique que imageHelper.js)
        function getBackendUrl() {
            if (typeof process !== 'undefined' && process.env && process.env.REACT_APP_API_URL) {
                return process.env.REACT_APP_API_URL;
            }
            
            const hostname = window.location.hostname;
            
            if (hostname === '74.235.205.26') {
                return 'http://74.235.205.26:4000';
            }
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:4000';
            }
            
            if (hostname === '10.1.0.4') {
                return 'http://10.1.0.4:4000';
            }
            
            return 'http://localhost:4000';
        }

        // Normalisation des URLs (m√™me logique que imageHelper.js)
        function normalizeImageUrl(url) {
            if (!url || typeof url !== 'string') return url;
            
            if (url.includes('cloudinary.com') || url.includes('res.cloudinary')) {
                return url;
            }
            
            const patterns = [
                'http://localhost:4000',
                'http://127.0.0.1:4000',
                'http://74.235.205.26:4000',
                'http://10.1.0.4:4000',
                'https://localhost:4000',
                'https://127.0.0.1:4000',
                'https://74.235.205.26:4000',
                'https://10.1.0.4:4000'
            ];
            
            for (const pattern of patterns) {
                if (url.startsWith(pattern)) {
                    return url.replace(pattern, '');
                }
            }
            
            return url;
        }

        // Obtenir URL d'image
        function getProductImageUrl(imageObj) {
            const BACKEND_URL = getBackendUrl();
            
            if (!imageObj) return '/images/default-product.jpg';
            
            let url = imageObj.url || imageObj.path || imageObj.public_id || '';
            if (!url) return '/images/default-product.jpg';
            
            // Normaliser
            url = normalizeImageUrl(url);
            
            // Si URL externe, retourner telle quelle
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            
            // Reconstruire avec bon domaine
            if (url.startsWith('/')) {
                return `${BACKEND_URL}${url}`;
            }
            
            return `${BACKEND_URL}/images/${url}`;
        }

        // Afficher les infos
        document.getElementById('hostname').textContent = window.location.hostname;
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('backend-url').textContent = getBackendUrl();
        document.getElementById('test-date').textContent = new Date().toLocaleString('fr-FR');

        let totalTests = 0;
        let passedTests = 0;

        function createImageTest(container, originalUrl, description) {
            const finalUrl = typeof originalUrl === 'object' ? getProductImageUrl(originalUrl) : getProductImageUrl({url: originalUrl});
            const div = document.createElement('div');
            div.className = 'image-test';
            
            const img = document.createElement('img');
            img.src = finalUrl;
            
            const info = document.createElement('div');
            info.className = 'image-info';
            info.innerHTML = `
                <strong>${description}</strong><br>
                <div class="url"><strong>URL Originale:</strong><br>${typeof originalUrl === 'object' ? originalUrl.url : originalUrl}</div>
                <div class="url"><strong>URL Normalis√©e:</strong><br>${normalizeImageUrl(typeof originalUrl === 'object' ? originalUrl.url : originalUrl)}</div>
                <div class="url"><strong>URL Finale:</strong><br>${finalUrl}</div>
                <span class="status" id="status-${totalTests}">‚è≥ Chargement...</span>
            `;
            
            const testId = totalTests;
            totalTests++;
            
            img.onload = function() {
                img.classList.add('loaded');
                document.getElementById(`status-${testId}`).textContent = '‚úÖ OK';
                document.getElementById(`status-${testId}`).className = 'status ok';
                passedTests++;
                updateResults();
            };
            
            img.onerror = function() {
                img.classList.add('error');
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect fill="%23f44336" width="150" height="150"/><text x="50%" y="50%" fill="white" text-anchor="middle" dy=".3em">ERROR</text></svg>';
                document.getElementById(`status-${testId}`).textContent = '‚ùå ERREUR';
                document.getElementById(`status-${testId}`).className = 'status fail';
                updateResults();
            };
            
            div.appendChild(img);
            div.appendChild(info);
            container.appendChild(div);
        }

        function updateResults() {
            const summary = document.getElementById('results-summary');
            const percentage = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            summary.innerHTML = `
                <h3>Score: ${passedTests}/${totalTests} (${percentage}%)</h3>
                <p><strong>Tests r√©ussis:</strong> ${passedTests}</p>
                <p><strong>Tests √©chou√©s:</strong> ${totalTests - passedTests}</p>
            `;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.className = percentage === 100 ? 'test-section success' : 'test-section error';
        }

        // Test 1: Charger produits depuis API
        fetch(`${getBackendUrl()}/api/product?page=1&limit=3`)
            .then(res => res.json())
            .then(data => {
                const products = data.products || data || [];
                const container = document.getElementById('products-container');
                
                if (products.length === 0) {
                    container.innerHTML = '<p>‚ö†Ô∏è Aucun produit trouv√©</p>';
                    return;
                }
                
                products.forEach((product, index) => {
                    if (product.images && product.images.length > 0) {
                        createImageTest(
                            container,
                            product.images[0],
                            `Produit "${product.title}" (ID: ${product.id})`
                        );
                    }
                });
            })
            .catch(err => {
                document.getElementById('products-container').innerHTML = 
                    `<p class="error">‚ùå Erreur API: ${err.message}</p>`;
            });

        // Test 2: URLs hardcod√©es
        const hardcodedTests = [
            {
                url: 'http://74.235.205.26:4000/images/images-1760904969855-950246712.jpeg',
                desc: 'URL avec IP Azure hardcod√©e'
            },
            {
                url: 'http://localhost:4000/images/images-1760904969855-950246712.jpeg',
                desc: 'URL avec localhost hardcod√©e'
            },
            {
                url: '/images/images-1760904969855-950246712.jpeg',
                desc: 'URL relative (chemin seul)'
            }
        ];

        const hardcodedContainer = document.getElementById('hardcoded-tests');
        hardcodedTests.forEach(test => {
            createImageTest(hardcodedContainer, test.url, test.desc);
        });

        // Test 3: Cloudinary
        const cloudinaryTests = [
            {
                url: 'https://res.cloudinary.com/dssruhspd/image/upload/v1760519719/ecommerce_products/kq9pt72bu24xhphbudzu.jpg',
                desc: 'Image Cloudinary (doit √™tre pr√©serv√©e)'
            }
        ];

        const cloudinaryContainer = document.getElementById('cloudinary-tests');
        cloudinaryTests.forEach(test => {
            createImageTest(cloudinaryContainer, test.url, test.desc);
        });
    </script>
</body>
</html>
